name: Daily Article Generation

on:
  schedule:
    # 2:00 PM Sri Lanka Time = 08:30 UTC
    - cron: '30 8 * * *'
  workflow_dispatch:

jobs:
  trigger-strapi-api:
    runs-on: ubuntu-latest

    steps:
      - name: Retry article generation up to 5 times
        run: |
          MAX_RETRIES=5
          RETRY_INTERVAL=120  # seconds (2 minutes)
          SUCCESS=false

          for ((i=1; i<=MAX_RETRIES; i++)); do
            echo "Attempt $i..."
            HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" -X POST "https://effortless-connection-2f75f4ee80.strapiapp.com/api/daily-article-generation" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.STRAPI_API_TOKEN }}")

            echo "Status code: $HTTP_CODE"
            cat response.json

            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "✅ Success on attempt $i"
              SUCCESS=true
              break
            else
              echo "❌ Failed attempt $i"
              if [ "$i" -lt "$MAX_RETRIES" ]; then
                echo "⏳ Waiting $RETRY_INTERVAL seconds before retrying..."
                sleep $RETRY_INTERVAL
              fi
            fi
          done

          if [ "$SUCCESS" = "false" ]; then
            echo "❌ All $MAX_RETRIES attempts failed."
            exit 1
          fi
