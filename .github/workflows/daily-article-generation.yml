name: Delete Old Articles Only (With Retries)
on:
  workflow_dispatch:
    inputs:
      force_cleanup:
        description: 'Force cleanup of old articles'
        required: false
        default: 'true'
        type: boolean

jobs:
  cleanup-old-articles:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old articles with retries
        id: cleanup
        run: |
          echo "ðŸ§¹ Starting cleanup of old articles..."
          echo "ðŸ“… Current time: $(date)"
          
          MAX_RETRIES=3
          RETRY_DELAY=60  # seconds (1 minute)
          SUCCESS=false
          
          for ((i=1; i<=MAX_RETRIES; i++)); do
            echo ""
            echo "ðŸ”„ Attempt $i of $MAX_RETRIES..."
            
            # Call the cleanup endpoint
            CLEANUP_RESPONSE=$(curl -s -w "%{http_code}" -o cleanup_response.json -X POST "https://effortless-connection-2f75f4ee80.strapiapp.com/api/delete-old-articles" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.STRAPI_API_TOKEN }}")
            
            echo "ðŸ“Š HTTP Status: $CLEANUP_RESPONSE"
            echo "ðŸ“„ Response Details:"
            cat cleanup_response.json
            echo ""
            
            if [ "$CLEANUP_RESPONSE" -eq 200 ] || [ "$CLEANUP_RESPONSE" -eq 207 ]; then
              echo "âœ… Cleanup completed successfully on attempt $i"
              SUCCESS=true
              break
            else
              echo "âŒ Attempt $i failed with status $CLEANUP_RESPONSE"
              
              if [ "$i" -lt "$MAX_RETRIES" ]; then
                echo "â³ Waiting $RETRY_DELAY seconds before retry..."
                sleep $RETRY_DELAY
              fi
            fi
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "âŒ All $MAX_RETRIES attempts failed!"
            echo "ðŸ” Final response:"
            cat cleanup_response.json
            echo ""
            echo "ðŸš¨ Cleanup failed - please check Strapi logs or server status"
            exit 1
          else
            echo "ðŸŽ‰ Cleanup completed successfully!"
            echo "âœ¨ Finished at: $(date)"
          fi
